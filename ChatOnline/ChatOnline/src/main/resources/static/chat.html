<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <title>Chat Online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>Chat</h1>

        <!-- Formulário de Envio de Mensagens -->
        <form id="send-form" class="d-flex gap-2 mb-4">
            <input type="text" id="message" placeholder="Digite sua mensagem" class="form-control">
            <input type="file" id="fileInput" class="form-control">
            <button type="submit" class="btn btn-warning" id="send" disabled>SEND</button>
        </form>

        <!-- Tabela de Mensagens -->
        <table class="table">
            <thead>
                <tr>
                    <th>Mensagem</th>
                    <th>De</th>
                    <th>Imagem</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>

    <script>
        // Verifica se o token está presente no localStorage antes de tentar conectar ao WebSocket
        if (!localStorage.getItem('Bearer Token')) {
            window.location.href = 'index.html';  // Redireciona para a página de login se o token não estiver presente
        }

        let stompClient = null;

        function connect() {
            const token = localStorage.getItem('Bearer Token');
            const username = localStorage.getItem('username');

            console.log("Token:", token);  // Verifica se o token está presente
            console.log("Username:", username);

            if (!token || !username) {
                window.location.href = 'index.html';  // Se por algum motivo o token ou o nome de usuário não estiverem presentes
            }

            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({ Authorization: `Bearer ${token}` }, (frame) => {
                console.log('Connected: ' + frame);
                $("#send").attr("disabled", false);

                stompClient.subscribe('/topic/messages', (message) => {
                    const data = JSON.parse(message.body);
                    let imageTag = '';

                    if (data.image) {
                        imageTag = `<img src="${data.image}" alt="User Image" width="100">`;
                    }

                    $("#tbody").append(`<tr><td>${data.message}</td><td>${data.from}</td><td>${imageTag}</td></tr>`);
                });
            }, (error) => {
                console.error('Connection error:', error);
                alert("Failed to connect to WebSocket. Please try again.");
            });
        }

        $("#send-form").submit((e) => {
            e.preventDefault();

            const fileInput = document.querySelector('#fileInput').files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                const base64Image = event.target.result;

                stompClient.send('/app/chat', {}, JSON.stringify({
                    to: localStorage.getItem('username'),
                    message: $("#message").val(),
                    from: localStorage.getItem('username'),
                    image: base64Image
                }));
            };

            if (fileInput) {
                reader.readAsDataURL(fileInput);
            } else {
                stompClient.send('/app/chat', {}, JSON.stringify({
                    to: localStorage.getItem('username'),
                    message: $("#message").val(),
                    from: localStorage.getItem('username')
                }));
            }
        });

        // Conecta ao WebSocket quando o documento estiver pronto
        $(document).ready(() => {
            connect();
        });
    </script>
</body>

</html>
